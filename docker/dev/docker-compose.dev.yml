name: StartsJokes

services:
  bot:
    build:
      context: ../..
      dockerfile: docker/dev/dockerfile.dev
    image: bot-image
    container_name: bot-container
    volumes:
      - ../../bot:/bot
    env_file:
      - ../../bot/.env
    depends_on:
      - postgres
      - redis
    command: sh -c "python main.py"

  postgres:
    image: postgres:17.5-alpine
    container_name: postgres-container
    env_file:
      - ../../bot/.env
    ports:
      - "5432:5432"
    restart: always
    volumes:
      - postgres_data:/var/lib/postgresql/data

  redis:
    image: redis:8.0.1-alpine
    container_name: redis-container
    restart: always
    volumes:
      - redis_data:/data

  gitlab:
    image: gitlab/gitlab-ce:17.10.7-ce.0
    container_name: gitlab
    restart: always
    hostname: "gitlab.university.com"
    environment:
      GITLAB_OMNIBUS_CONFIG: |
        external_url 'http://gitlab.university.com'
    ports:
      - "80:80"
      - "22:22"
    volumes:
      - "gitlab_config:/etc/gitlab"
      - "gitlab_logs:/var/log/gitlab"
      - "gitlab_data:/var/opt/gitlab"
    shm_size: "256m"

  gitlab-runner:
    image: gitlab/gitlab-runner:alpine3.19-2147fb44
    container_name: gitlab-runner
    restart: always
    volumes:
      - gitlab_runner_config:/etc/gitlab-runner
      - /var/run/docker.sock:/var/run/docker.sock
    depends_on:
      - gitlab

volumes:
  postgres_data:
  redis_data:
  gitlab_config:
  gitlab_logs:
  gitlab_data:
  gitlab_runner_config:
